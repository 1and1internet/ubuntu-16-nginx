#!/usr/bin/env bash

SITE_FOLDER=/var/www/html
CUSTOMER_NGINX_CONF=$SITE_FOLDER/nginx.conf

function do_sighup {
    echo -n "SIGHUP sent at "; date
    kill -HUP $(cat /var/run/nginx.pid)
}

function loop_forever {
    # We must ignore OPEN events - we are not interested if nginx opens
    # a file (which it is always doing)
    while [ 1 ]; do
        if [ -f $CUSTOMER_NGINX_CONF ]; then
            # There is a custom nginx.conf, so watch for changes
            inotifywait -e MODIFY -e DELETE -e CLOSE_WRITE $CUSTOMER_NGINX_CONF
            do_sighup
        else
            # There is no custom nginx.conf, so wait for one
            while [ ! -f $CUSTOMER_NGINX_CONF ]; do
                inotifywait -e CREATE -e DELETE $SITE_FOLDER
            done
            do_sighup
        fi
    done
}

loop_forever > /var/log/nginx/reloader.log 2>&1
